---
import { getCollection } from 'astro:content';
import Layout from '@layouts/Layout.astro';
import { createSlug } from '@utils/utils';
import { formatDate } from '@utils/utils';

let posts = await getCollection('posts');
// if we are production mode, filter out drafts
if (import.meta.env.PROD) {
  posts = posts.filter((draft) => !draft.data.draft);
}

// Sort posts by publication date
let sortedPosts = posts.sort(
  (a, b) =>
    new Date(b.data.pubDate).valueOf() - new Date(a.data.pubDate).valueOf()
);
---

<Layout title="Blog">
  <section id="blogPosts">
    <h1 class="mb-2 text-4xl">Blog-Beitr√§ge ({posts.length})</h1>

    <ul class="mt-8 list-none px-6 py-4 rounded-2xl">
      {
        sortedPosts.map((post) => (
          <li class="flex flex-row justify-between mb-2 rounded-xl p-4">
            <div class="flex flex-col ">
              <h2 class="text-left">
                <a
                  href={`/blog/${createSlug(post.data.title)}/`}
                  class="flex items-center hover:fill-black underline hover:underline"
                >
                  {post.data.title}
                </a>
                {post.data?.draft ? (
                  <span class="ml-2 px-2 py-1 rounded text-xs">DRAFT</span>
                ) : (
                  ''
                )}
              </h2>
              {post.data.tags && (
                <div class="flex flex-wrap gap-2 mt-1">
                  {post.data.tags.map((tag) => (
                    <span class="text-xs px-2 py-1 rounded">{tag}</span>
                  ))}
                </div>
              )}
            </div>

            <span>
              <time datetime={post.data.pubDate.toISOString()}>
                {formatDate(post.data.pubDate.toString())}
              </time>
            </span>
          </li>
        ))
      }
    </ul>
  </section>
</Layout>
